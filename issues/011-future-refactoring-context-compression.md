# 将来のリファクタリング課題

## Epic 10 Task A - コンテキスト圧縮機能

### 課題1: `prune_history_sliding_window`の堅牢性向上

**現状**:
- インデックス操作（`i -= 2`など）に依存したロジック
- `user`と`assistant`の厳密なペアを暗黙的に前提
- 予期せぬ入力（user連続、system混入など）で破綻する可能性

**推奨される改善**:
1. 履歴を「会話ターン」（user + assistant のペア）単位に変換
2. ターン単位でトークン計算と枝刈りを実行
3. インデックス操作を排除し、可読性・保守性を向上

**優先度**: 中（現在のテストは通っており基本動作は保証されているが、将来的な拡張性のため改善推奨）

**参考**: Gemini レビューコメント（2025-11-16）

---

### 課題2: トークン計算の重複除去

**現状**:
- `get_pruning_info()`が`prune_history_sliding_window()`を内部で呼び出し
- 同じ履歴に対してトークン計算が2回実行される（O(n)の無駄）

**推奨される改善**:
- トークン計算結果をキャッシュ
- または`prune_history_sliding_window()`から計算済みトークン情報を返す設計に変更

**優先度**: 低（パフォーマンス最適化。MVP段階では影響小）

**参考**: Copilot レビューコメント（2025-11-16）

---

## 作成日
2025-11-17

## 関連ドキュメント
- `doc/context_compression_requirements.md`
- `issues/010-task-parallel-context-history.md`
