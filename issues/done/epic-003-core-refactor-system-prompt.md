# Epic: Core Refactor & System Prompt Control

## 概要
既存の`app.py`/`chat_logic.py`構成を分離し、共有ロジックを`core.py`へ集約したうえで、セッションベースのシステムプロンプト機能をWeb UIとCLIの双方に実装する。  
（参照: `doc/system_prompt_feature_requirements.md`）

## 目的
- UI/CLIが同じビジネスロジックを再利用できるよう責務分離する。
- 各LLMへ一貫したシステムプロンプトを適用し、ユーザーが応答スタイルを制御できるようにする。
- 将来のコンテキスト圧縮/履歴保存機能の基盤を整える。

## Stories

### Story: Core層への責務集約とエントリーポイント再編
- **概要**: APIキー読み込み、モデルインスタンス管理、履歴フォーマッタなどUI非依存ロジックを`core.py`へ移し、`webui.py`/`cli.py`を薄いエントリーポイントにする。
- **Acceptance Criteria**:
    - `core.py`にAPI設定、モデルラッパー、履歴整形、共通ユーティリティ（トークン計算のスタブ含む）が実装されている。
    - 旧`app.py`は`webui.py`へリネームされ、Gradioロジックのみ保持する。
    - 旧`chat_logic.py`の対話ループは`cli.py`へ移行し、`core.py`を介してLLMを呼び出す。
    - 既存テストは`tests/test_core.py`と`tests/test_cli.py`に再編され、ルートに不要な旧ファイルが残っていない。
- **Tasks**:
    - **Task: Shareable core moduleの新設** — APIキー読み込み、モデルクライアント生成、履歴フォーマッタを`core.py`に移植し、他モジュールからインポートできるよう公開関数を整理する。
    - **Task: エントリーポイントの分割とリネーム** — `app.py`→`webui.py`、`chat_logic.py`→`cli.py`へ移行し、すべてのインポート・起動手順・README記述を更新する。
    - **Task: テストスイートの再配置** — 既存`tests/test_chat_logic.py`を分割し、coreレイヤとCLI振る舞いを個別に検証する新しいテストファイルを追加する。

### Story: システムプロンプト適用ロジック
- **概要**: `core.py`にシステムプロンプト入力を受け取り、API向け履歴へ適切に挿入する仕組みと、モデルキャッシュのリセットを実装する。
- **Acceptance Criteria**:
    - `prepare_request(history, system_prompt, model_name)`がOpenAI/Gemini向けに正しいフォーマットを返す。
    - システムプロンプト変更時にGeminiモデルキャッシュが再初期化される。
    - `get_token_info`が`{"count": <int>, "max_allowed": <int>, "is_estimated": <bool>}`を返し、現段階では簡易な概算実装でもよいが、Epic 4で精緻化されることを明記している。
- **Tasks**:
    - **Task: リクエスト整形とキャッシュ制御** — モデル別の履歴構築を統合し、システムプロンプト更新時に該当クライアントを再生成するロジックを追加。
    - **Task: トークン情報APIの実装** — `get_token_info`がトークン数・最大長・推定フラグを返すようにし、未設定モデルにはデフォルトを適用する。Gemini等の概算ロジックは簡易でよく、Epic 4でプロバイダ別精度向上を行う旨をコメントする。

### Story: Web UIでのシステムプロンプト編集
- **概要**: Gradio UIにシステムプロンプト入力欄とトークン残量表示を追加し、上限超過時は送信ボタンを無効化・警告表示する。
- **Acceptance Criteria**:
    - `gr.Textbox(lines>=3)`でプロンプトを編集でき、入力が変更されるたびに`get_token_info`結果が表示される。
    - 最大コンテキスト長を超える場合、赤字警告と送信操作の無効化が行われる。
    - 新規会話を開始してもシステムプロンプトは維持される。
- **Tasks**:
    - **Task: UIコンポーネントの追加** — テキストボックスとトークンステータス`gr.Markdown`を配置し、ユーザー操作フローを更新する。
    - **Task: トークン監視と送信制御** — 入力イベントで`get_token_info`を呼び出し、超過時にボタン無効化と警告表示を行うロジックを実装する。

### Story: CLI `/system` コマンド体系
- **概要**: CLIにシステムプロンプト設定・表示・解除コマンドを導入し、トークン上限を超える入力をブロックする。
- **Acceptance Criteria**:
    - `/system <text>`で設定、`/system`で現在値表示、`/system clear`で解除できる。
    - 各コマンドで`get_token_info`を使用し、上限超過時は警告を表示して設定をキャンセルする。
    - 未知の`/`コマンドにはガイド付きエラーメッセージを返す。
- **Tasks**:
    - **Task: コマンドパーサの追加** — `/system`コマンドをCLIループに統合し、通常入力と区別して処理する。
    - **Task: トークン検証と応答** — コマンド処理内でトークン数をチェックし、結果に応じた成功・失敗メッセージを整備する。

### Story: システムプロンプトの永続化と復元
- **概要**: 履歴保存・読み込み処理にシステムプロンプトを含め、復元時にUI/CLIへ反映する。
- **Acceptance Criteria**:
    - 履歴JSONへ`system_prompt`が保存され、読み込み時に現在のセッションへ適用される。
    - 保存済み履歴を読み込むと、Web UIテキストボックスおよびCLI設定が即座に更新される。
    - 新規会話開始時も前回のプロンプトが保持される仕様がドキュメント化されている。
- **Tasks**:
    - **Task: ストレージスキーマ拡張** — 履歴ファイル形式にシステムプロンプトを追加し、既存データとの互換性を確保する。
    - **Task: UI/CLI状態同期** — 読み込み処理でシステムプロンプトを各インターフェースへ反映し、初期レンダリングや起動メッセージを更新する。
