# Epic: Context Compression & Token Guardrails

## 概要
モデルごとの最大コンテキスト長を管理し、トークン数を計測・枝刈りしてAPI上限超過やコスト増を防ぐ。  
（参照: `doc/context_compression_requirements.md`）

## 目的
- 送信履歴が上限を超える前に自動的に調整し、失敗レスポンスを減らす。
- システムプロンプトや直近会話を保護しつつ、安全なトークンバジェット内でやり取りを継続する。
- 将来の高度な圧縮方式へ拡張しやすいトークン計算レイヤを整備する。

## Stories

### Story: モデル別最大コンテキスト設定
- **概要**: 環境変数からモデルごとの`*_MAX_CONTEXT_LENGTH`を読み取り、未設定時はデフォルト値にフォールバックする。
- **Acceptance Criteria**:
    - `GEMINI_MAX_CONTEXT_LENGTH`や`CHATGPT_MAX_CONTEXT_LENGTH`を読み込み、数値に変換できない場合は警告ログを出してデフォルトを使用する。
    - 未設定モデルには`DEFAULT_MAX_CONTEXT_LENGTH`が適用される。
    - 設定値は`core.py`のAPIで参照可能で、UI/CLIからも確認できる。
- **Tasks**:
    - **Task: 環境変数ローダ実装** — 最大長とデフォルト値を読み込み・検証し、`core`内部で参照できる設定オブジェクトを整備する。
    - **Task: ロギングとフォールバック** — 不正値検出時の警告とフォールバックルールを記述し、READMEに設定方法を追記する。

### Story: トークン計測サービス
- **概要**: プロバイダごとに計測ロジックを切り替え、概算時は安全マージンを掛ける`get_token_info`を実装する。
- **Acceptance Criteria**:
    - OpenAIは`tiktoken`で正確に計測し、Geminiなど計測できないモデルには文字数ベースの概算+`TOKEN_ESTIMATION_BUFFER_FACTOR`を適用する。
    - 戻り値に`count`, `max_allowed`, `is_estimated`を含む。
    - 未対応プロバイダを簡単に追加できるプラガブルな構造である。
- **Tasks**:
    - **Task: プロバイダ別トークナイザ登録** — 関数ディクショナリ等を用いて、モデル→計測関数のマッピングを実装する。
    - **Task: バッファ係数の設定** — 概算に安全マージンを適用し、環境変数で係数を調整できるようにする。

### Story: スライディングウィンドウ枝刈り
- **概要**: API送信直前に最新ターンを優先して履歴を削減し、最大長内へ収める。
- **Acceptance Criteria**:
    - システムプロンプトを常に保持し、それ以外の履歴をターン単位で古いものから削除する。
    - 削減はリクエスト生成時のみ行われ、永続化済み履歴は改変されない。
    - モデルごとに最大長を取得し、リクエストごとに評価・枝刈りする。
- **Tasks**:
    - **Task: 枝刈りアルゴリズム実装** — システムプロンプトを除外しつつターン単位で履歴リストを縮めるロジックを追加する。
    - **Task: モデル別ループ統合** — Gemini/OpenAI双方のリクエスト準備フローに枝刈り処理を組み込み、セッション中のモデル切り替えにも対応する。

### Story: トークン超過時のユーザー通知
- **概要**: システムプロンプトや単一ターンが最大長を超える場合に、UI/CLIへ明確な警告を表示して送信を中断する。
- **Acceptance Criteria**:
    - システムプロンプト単体で上限超過した際、Web UIは送信を無効化し、CLIはエラーメッセージで設定を拒否する。
    - システムプロンプト+最新ターンでも収まらない場合、両インターフェースが「コンテキストが長すぎる」と表示し、API呼び出しをスキップする。
    - 超過イベントはログに残され、デバッグ時に原因を追える。
- **Tasks**:
    - **Task: UI警告フロー** — Web UIの警告表示・ボタン無効化を再利用し、コンテキスト超過時にも適用する。
    - **Task: CLIエラーハンドリング** — トークン超過条件をCLI出力に反映し、送信前チェックで処理を中断する。
