# Epic: Conversation History Persistence

## 概要
会話履歴をユーザーごとにローカル保存し、複数セッションを一覧・保存・読み込みできるようにする。  
（参照: `doc/history_feature_requirements.md`）

## 目的
- 再起動後も過去のチャットを再開できるようにする。
- ユーザーIDと保存名で履歴を整理し、将来の認証・データベース移行へ備える。
- UI/CLI両方から安全に履歴操作できる共通フローを提供する。

## Stories

### Story: ユーザーID入力と警告表示
- **概要**: セッション開始時にユーザーIDを取得し、なりすましリスクの注意喚起を行う。IDが未設定の場合、履歴操作を無効化する。
- **Acceptance Criteria**:
    - Web UIにユーザーIDテキストボックスと警告メッセージを表示し、入力完了までチャット/履歴UIを非活性化する。
    - CLI起動時にユーザーIDを尋ね、空や無効な値は再入力させる。
    - 入力時に「これは認証ではありません」等の警告を表示する。
- **Tasks**:
    - **Task: UI/CLI入力フロー実装** — 両インターフェースでユーザーID取得→検証→状態保存までの流れを追加する。
    - **Task: 警告メッセージの表示** — SR-2に従い、なりすましリスク警告をUI/CLIへ実装する。

### Story: 履歴ファイルの保存形式とI/O
- **概要**: `chat_histories/<sanitized_user>/<sanitized_name>.json`に履歴を保存し、システムプロンプトやメタデータを含める。
- **Acceptance Criteria**:
    - JSONフォーマットが`display_name`, `system_prompt`, `turns`, `metadata`を持つ。
    - `chat_histories/`が未存在なら作成し、`.gitignore`へ追記されている。
    - 保存・読み込み時にファイルI/Oエラーを検知し、明確なメッセージを返す。
- **Tasks**:
    - **Task: ストレージレイヤ実装** — ディレクトリ作成、ファイル名規約、JSONスキーマを実装し、既存履歴との互換を検証する。
    - **Task: エラーハンドリング整備** — 読み書き失敗時のログとユーザー通知を統一し、単体テストを追加する。

### Story: Web UIの履歴管理パネル
- **概要**: ユーザーIDに紐づく履歴一覧を取得し、保存・読み込み・新規開始操作を提供するUI領域を追加する。
- **Acceptance Criteria**:
    - `gr.Dropdown`で履歴一覧を選択でき、表示名にはサニタイズ前の`display_name`を使用する。
    - 「現在の会話を保存」「選択した会話を読み込む」「新しい会話を開始」ボタンがあり、未保存の会話を破棄する際は確認モーダルまたは警告メッセージが表示される。
    - 履歴操作成功後にドロップダウンが最新状態へリフレッシュされる。
- **Tasks**:
    - **Task: Gradioコンポーネント追加** — 履歴操作用UIを構築し、ユーザーID変更時に選択肢を更新するロジックを実装する。
    - **Task: 確認ダイアログとUX整備** — 未保存破棄や上書き時の確認メッセージを実装し、仕様で要求されるフローを満たす。

### Story: CLI `/history` コマンド群
- **概要**: CLIで履歴の一覧表示・保存・読み込み・新規開始を行う`/history`系コマンドを提供する。
- **Acceptance Criteria**:
    - `/history list|save <name>|load <name>|new`を実行でき、存在しない名前や未保存状態に応じて確認メッセージを表示する。
    - `<name>`にスペースを含む場合、ダブルクォーテーションをサポートする。
    - 保存時に重複名がある場合、上書き確認を行い、同意を得るまで書き込まない。
- **Tasks**:
    - **Task: コマンドパーサ実装** — CLIに`/history`サブコマンドを追加し、引数解析とエラーハンドリングを行う。
    - **Task: 上書き確認フロー** — SR-1/FR-7に従い、重複時の確認メッセージとキャンセル処理を実装する。

### Story: サニタイズとセキュリティ対策
- **概要**: ユーザーID・保存名を安全な文字列へ変換し、`chat_histories/`をリポジトリ管理外に保つ。
- **Acceptance Criteria**:
    - 許可文字以外を`_`に置換し、空/`.`/`..`になった場合はエラーとする。
    - `chat_histories/`が`.gitignore`に登録され、既存履歴を誤ってコミットしない。
    - 危険なパスを入力した場合は保存を中断し、再入力を促す。
- **Tasks**:
    - **Task: サニタイズヘルパー作成** — SR-1準拠の変換関数とバリデーションロジックを共有ユーティリティ化し、テストを追加する。
    - **Task: Git設定更新** — `.gitignore`へ`chat_histories/`を追記し、ドキュメントにディレクトリ構造を記述する。
