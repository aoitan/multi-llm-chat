# WebUI 履歴管理機能 仕様書

## 1. 概要
WebUI上でユーザーIDに紐づく会話履歴を保存・一覧・読み込み・新規開始できるようにする。既存のCLI `/history` 系コマンドと概念を揃え、システムプロンプトやトークン表示とも連動させる。

## 2. 背景
- CLIでは履歴保存/読み込みが利用可能だが、WebUIには同等機能がない。
- ユーザーIDに紐づく履歴管理をUIから行いたいという要望があり、CLIと機能差分を埋める必要がある。
- トークン表示やコンテキスト圧縮と整合した状態更新が求められる。

## 3. 機能要件
- ユーザーID入力と注意喚起を行い、未入力時は履歴操作と送信を無効化する。
- 会話履歴の保存・一覧・読み込み・新規開始をWebUIから行える。
- 未保存セッションを破棄する操作（読込/新規）や既存名への保存時に確認を求める。
- 読込・新規後はチャット履歴、システムプロンプト、トークン表示を即時更新する。

## 4. UI仕様（Gradio）
### 4.1 コンポーネント
- ユーザーID入力 `gr.Textbox` と注意文（「これは認証ではありません」「他人のIDを使わないでください」）。
- 履歴パネル（Row/ColumnまたはAccordion）に以下を配置:
  - 履歴一覧 `gr.Dropdown`（表示名で表記）。
  - 保存名入力 `gr.Textbox` と `現在の会話を保存` ボタン。
  - `選択した会話を読み込む` ボタン。
  - `新しい会話を開始` ボタン。
  - 操作前の確認: モーダル風テキスト＋Yes/Noボタンで上書き・未保存破棄・読込置換を確認。
- 状態表示 `gr.Markdown` で成功/エラーを通知。
- レイアウトはレスポンシブで崩れないRow/Column構成。

### 4.2 挙動
- ユーザーID未入力時は履歴ボタンと送信を非活性。
- 保存:
  - 表示名をサニタイズし `chat_histories/<user>/<name>.json` に書き込む。
  - 同名がある場合は上書き確認（Yes/No）。Noで中断。
  - 成功後に履歴一覧をリフレッシュ。
- 読み込み:
  - ドロップダウン選択の履歴を読み込み、チャット表示・内部履歴・システムプロンプトを置き換える。
  - 未保存セッションがある場合は破棄確認（Yes/No）。
- 新規開始:
  - チャット履歴とシステムプロンプトをリセット（要件指定）。未保存があれば確認（Yes/No）。
- 各操作後に `get_token_info` を用いてトークン表示と送信ボタン状態を更新。

## 5. データ仕様
- 既存 `HistoryStore` のJSONスキーマ（`display_name`, `system_prompt`, `turns`, `metadata`）を利用。
- ファイル配置: `chat_histories/<sanitized_user>/<sanitized_name>.json`。
- サニタイズと検証はCLIと共通のルールを使用する。

## 6. 非機能要件
- I/Oエラーや無効な名前はユーザー向けメッセージを表示し、例外はログへ記録。
- トークン表示・送信制御は既存ロジックを再利用し、過剰な再計算を避ける。

## 7. テスト
- `test_webui.py` などで以下を検証:
  - 有効/無効ユーザーIDでの活性制御。
  - 保存サニタイズと上書き確認のYes/No分岐。
  - 読込で履歴/システムプロンプトが置換されること。
  - 新規開始で履歴とシステムプロンプトがリセットされること。
  - 未保存破棄確認のYes/No分岐。

## 8. Open Questions / Follow-ups
- 確認UIはRow構成（メッセージ＋Yes/Noボタン）で実装するが、将来的にモーダルコンポーネントが提供された場合は置き換える。
- トースト/スナック的な簡易通知を追加するかは実装時に検討する。
