# 全体リファクタリングと新機能要件定義：システムプロンプト設定機能

### 1. 概要

今後の機能拡張を見据え、プロジェクト全体のファイル構成をリファクタリングし、責務の分離を行う。その上で、AIの役割や応答スタイルを指示するための「システムプロンプト」を設定する機能を追加する。

### 2. 全体リファクタリング計画

現在の`app.py`と`chat_logic.py`を、以下の3つのファイルに再編成する。

-   `core.py` (新設)
    -   **役割**: アプリケーションの核となる、UIに依存しない共通ロジックを格納する。
    -   **主な内容**:
        -   APIキーの読み込み
        -   `call_gemini_api`, `call_chatgpt_api` などのAPI呼び出し関数
        -   履歴フォーマット関数
        -   今後実装するコンテキスト圧縮ロジック
        -   今回追加するシステムプロンプト適用ロジック

-   `webui.py` (`app.py`からリネーム)
    -   **役割**: Gradioを使ったWeb UIの実装に特化する。
    -   **主な内容**:
        -   Gradioコンポーネントの定義とレイアウト
        -   UIイベント（ボタンクリックなど）のハンドリング
        -   `core.py`の関数を呼び出して、UIを更新する

-   `cli.py` (`chat_logic.py`から分離)
    -   **役割**: コマンドラインインターフェース（CLI）の実装に特化する。
    -   **主な内容**:
        -   `input()` を使った対話ループ
        -   ユーザー入力の解析
        -   `core.py`の関数を呼び出して、結果をコンソールに表示する

この再編成により、`chat_logic.py`は`core.py`と`cli.py`に分割され、廃止される。

### 3. システムプロンプト機能 要件定義

-   **FR-1: システムプロンプトの適用**
    -   ユーザーは、会話の開始時にAIの役割や応答の前提条件（例: 「あなたはプロの翻訳家です」「JSON形式で応答してください」）を「システムプロンプト」として設定できる。
    -   設定されたシステムプロンプトは、APIに送信される会話履歴の先頭に、各モデルに適した形式で挿入される。

-   **FR-2: Web UIでの設定**
    -   Web UIに、複数行入力可能なテキストボックスを設置し、ユーザーがセッションごとにシステムプロンプトを入力・編集できるようにする。

-   **FR-3: CLIでの設定**
    -   CLIに、システムプロンプトを設定・変更するための特別なコマンド（例: `/system <プロンプト内容>`）を導入する。

### 4. MVP設計提案

-   **`core.py`**:
    -   `apply_system_prompt(history, system_prompt)` のような、会話履歴の先頭にシステムプロンプトを挿入する関数を新設する。OpenAIの`system`ロールと、Geminiの初回ユーザープロンプト形式の両方に対応する。

-   **`webui.py`**:
    -   `gr.Textbox(lines=3, label="System Prompt")` をUI上部に追加する。その内容は`gr.State`で管理し、応答生成時に`core.py`の関数に渡す。

-   **`cli.py`**:
    -   対話ループの中で、ユーザー入力が `/` で始まる場合は、それをコマンドとして解釈するロジックを追加する。
