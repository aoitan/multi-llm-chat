# コンテキスト圧縮機能仕様

## 1. 目的

LLM（Large Language Models）には入力可能なトークン数（コンテキストウィンドウ）に上限があります。
長い会話を続けるとこの上限を超え、エラーが発生したり、古い情報が忘れられたりします。

コンテキスト圧縮機能は、会話履歴のトークン数を管理し、上限を超えないように自動的に古い履歴を整理（プルーニング）することで、長期間の対話を可能にします。

## 2. 実装詳細

実装は `src/multi_llm_chat/compression.py` で提供されています。

### 2.1 アルゴリズム: スライディングウィンドウ

本システムでは、最もシンプルかつ効果的な「スライディングウィンドウ」方式を採用しています。

1.  **最新維持**: 直近の会話は最も重要であるため、必ず保持します。
2.  **ターン単位の削除**: 会話の整合性を保つため、単なる行単位ではなく、「ユーザー発言」＋「それに対するAI応答（複数可）」を1つの**ターン**として扱い、ターン単位で削除します。
3.  **システムプロンプト保護**: システムプロンプト（AIの役割設定など）は最優先で保護され、削除されません。

### 2.2 ロジックの流れ

`prune_history_sliding_window` 関数の処理フローは以下の通りです。

1.  **トークン計算**: 現在の履歴の全トークン数を計算します。
    *   `token_utils.py` を使用し、モデルに応じたエンコーディングで計算します。
    *   OpenAI以外のモデルでは、近似計算にバッファ係数（デフォルト1.2倍）を乗じて安全マージンを取ります。
2.  **判定**: 上限（`max_tokens`）以下であれば、何もせず終了します。
3.  **プルーニング（枝刈り）**:
    *   履歴の**古い方（先頭）**から削除候補を探します（ただしシステムプロンプトは除く）。
    *   **逆順走査**: 実装上は、履歴の**新しい方（末尾）**から順に「保持するターン」を確定させていく方式をとっています。
    *   容量（`max_tokens`）が一杯になるまで、新しいターンから順にバケツに入れていくイメージです。入り切らなかった古いターンが結果的に削除されます。

### 2.3 構成要素

*   **システムプロンプト**: 常に保持。
*   **User Message**: ターンの開始点。
*   **Assistant Message(s)**: User Messageに続く応答。`@all` メンション時はGeminiとChatGPTの両方の応答が含まれるため、これらをまとめて1ターンとします。

## 3. API仕様

### `prune_history_sliding_window`

```python
def prune_history_sliding_window(
    history: List[Dict],
    max_tokens: int,
    model_name: str,
    system_prompt: Optional[str] = None,
    token_calculator: Callable = None,
) -> List[Dict]
```

*   **引数**:
    *   `history`: 会話履歴のリスト。
    *   `max_tokens`: 許容される最大トークン数。
    *   `model_name`: トークン計算に使用するモデル名。
*   **戻り値**: 圧縮（プルーニング）された新しい履歴リスト。

### `get_pruning_info`

圧縮を実行した場合に、どれくらい削減されるかをシミュレーションして情報を返します（UI表示用）。

*   **戻り値**:
    *   `turns_to_remove`: 削除されるターン数。
    *   `original_length`: 元のトークン数。
    *   `pruned_length`: 圧縮後のトークン数。

## 4. 制限事項

*   **要約（Summarization）は未実装**: 現在は古い履歴の切り捨て（Drop）のみです。過去の内容を要約して残す機能は将来の拡張候補です。
*   **トークン計算の精度**: OpenAI以外のモデル（Gemini等）については、完全なトークナイザが公開されていない場合があり、文字数ベース等の近似計算を行っている箇所があります。そのため、設定した `max_tokens` ギリギリまで使えるわけではなく、安全マージンが含まれます。
