# Gradio Web UI 設計書

## 1. 概要

現在のCLIベースのMulti-LLMチャットツールに、Gradioライブラリを用いて直感的なWebユーザーインターフェイスを実装する。これにより、ユーザビリティを大幅に向上させる。

## 2. 要求仕様

- **チャット形式のUI**: 会話履歴が時系列で表示され、ユーザーがメッセージを入力して送信できる、一般的なチャットアプリケーションと同様のインターフェイスを持つ。
- **LLMの選択**: ユーザーは`@gemini`, `@chatgpt`, `@all`といったメンションを入力に含めることで、応答を生成するLLMを指定できる。
- **思考メモ**: メンションのない入力は、APIを呼び出さずに会話履歴にのみ追加される「思考メモ」として扱われる。
- **ストリーミング表示**: LLMからの応答を、生成され次第リアルタイムでUIにストリーミング表示し、待機時間を短縮する。
- **状態管理**: セッション中の会話履歴は、ページをリロードしない限り保持される。

## 3. 設計

### 3.1. アーキテクチャ概要

Gradioのイベント駆動モデルをベースに、UIコンポーネントとバックエンドの処理関数を連携させる。会話履歴は`gr.State`を用いて管理し、ユーザーの入力があるたびに更新される。

### 3.2. データフロー図 (Mermaid)

```mermaid
graph TD
    subgraph "Gradio UI (app.py)"
        A[gr.Textbox: ユーザー入力] --> B{送信イベント};
        C[gr.Chatbot: 会話表示];
        B --> D[Python: メイン処理関数];
    end

    subgraph "Backend Logic (chat_logic.py)"
        D --> E{入力解析 (@mention)};
        E -->|@gemini| F[call_gemini_api];
        E -->|@chatgpt| G[call_chatgpt_api];
        E -->|@all| H[call_gemini_api & call_chatgpt_api];
        F --> I[LLM応答ストリーム];
        G --> I;
        H --> I;
    end

    subgraph "State"
        J[gr.State: 会話履歴];
    end

    %% データ連携
    D -- 読み込み --> J;
    B -- ユーザー入力を渡す --> D;
    I -- チャンクごとに履歴を更新 --> D;
    D -- 更新された全履歴をyield --> C;
    D -- 書き込み --> J;

```

## 4. 実装計画

1.  **環境構築**:
    -   `uv pip install gradio` を実行し、Gradioをプロジェクトに追加する。

2.  **ファイル構成**:
    -   Web UI関連のコードを格納するため、新たに`app.py`を作成する。
    -   既存の`main.py`は、`app.py`から呼び出されるバックエンドロジックのモジュールとして再利用する。`main`ガード(`if __name__ == "__main__":`)内のCLIループ部分は削除または`cli.py`などに分離する。

3.  **UIスケルトンの実装 (`app.py`)**:
    -   `gr.Blocks()`を用いてUIのレイアウトを定義する。
    -   `gr.Chatbot`で会話表示エリアを、`gr.Textbox`で入力欄を配置する。
    -   `gr.State`で会話履歴を管理する変数を初期化する。

4.  **バックエンドロジックの統合 (`app.py`)**:
    -   ユーザー入力と会話履歴を引数に取り、更新された会話履歴を返すメインの処理関数を定義する。
    -   この関数内で、`main.py`からインポートしたAPI呼び出し関数 (`call_gemini_api`, `call_chatgpt_api`) を使用する。

5.  **ストリーミングの実装**:
    -   メイン処理関数をジェネレータとして定義する。
    -   API呼び出しジェネレータから受け取った応答チャンクを、その都度、会話履歴の末尾に追加する。
    -   チャンクを追加した**完全な会話履歴**を `yield` でUIに送り返す。これを繰り返すことで、`gr.Chatbot`コンポーネントがリアルタイムに更新される。

## 5. 今後の展望

-   エラーハンドリングの強化（APIエラー発生時にUIにメッセージを表示）。
-   会話履歴をクリアするボタンの追加。
-   UIのテーマやスタイルの調整。
