# 新機能要件定義：会話履歴の保存・管理機能

### 1. 概要

現在のチャットアプリケーションに、会話履歴を永続化し、ユーザーごとに管理する機能を追加する。ユーザーは複数の会話履歴を保存し、後から呼び出すことができる。将来的な認証機能の導入を見据え、拡張性の高い設計とする。

### 2. 機能要件 (FR)

-   **FR-1: ユーザー識別**
    -   システムはユーザーを一意に識別できること。
    -   MVP（Minimum Viable Product）段階では、ユーザーが任意の「ユーザーID」を入力する方式とする。

-   **FR-2: 履歴の永続化**
    -   会話履歴は、アプリケーションを再起動しても失われないように永続化されること。
    -   MVP段階では、ローカルファイルシステムへの保存を想定する。

-   **FR-3: 複数履歴の管理**
    -   一人のユーザーは、複数の会話履歴をそれぞれ異なる名前で保存・管理できること。

-   **FR-4: 新規会話の開始**
    -   ユーザーはいつでも現在の会話をクリアし、新しい会話を開始できること。

-   **FR-5: 会話の保存**
    -   ユーザーは現在の会話履歴に名前を付けて保存できること。

-   **FR-6: 会話の読み込み**
    -   ユーザーは保存済みの会話履歴の一覧から一つを選択し、現在のチャットに読み込んで会話を再開できること。
    -   読み込まれた履歴には、保存されていたシステムプロンプトも復元されること。（`system_prompt_feature_requirements.md` の実装に依存）

-   **FR-7: 上書き保存の制御**
    -   ユーザーが「現在の会話を保存」ボタンを押した際、まず入力された「保存名」に対してSR-1のサニタイズ処理を行う。
    -   サニタイズ後の名前が既存の保存名と重複する場合、「同じ名前の履歴が存在します。上書きしますか？」という確認をUI上で表示し、同意が得られた場合のみ上書き保存を実行する。

### 3. 非機能要件 (NFR)

-   **NFR-1: プライバシー**
    -   あるユーザーの会話履歴は、他のユーザーからは閲覧・アクセスできないこと。データはユーザーIDによって明確に分離される必要がある。

-   **NFR-2: 拡張性**
    -   ユーザー識別メカニズムは、将来的にOAuthなどの本格的な認証システムに置き換え可能であるように設計すること。平文のユーザーIDから認証済みIDへのデータマイグレーションパスも将来的に考慮する必要がある。
    -   履歴保存フォーマットは、将来の拡張（例: 使用モデル、圧縮方式などのメタデータ追加）を考慮し、柔軟な構造（例: JSONオブジェクトのルートに`metadata`キーを設ける）とすること。

### 4. セキュリティ要件 (SR)

-   **SR-1: パストラバーサル対策とファイル名エンコーディング**
    -   ユーザーが入力する「ユーザーID」および「会話の保存名」は、ファイルパスとして安全な文字列に変換すること。
    -   具体的には、入力文字列をBase64（URL-safe variant）でエンコードしてファイル名・ディレクトリ名として使用する。これにより、マルチバイト文字をサポートしつつ、ファイルシステムで問題となる文字 (`/`, `..` 等) を排除する。
    -   エンコード前の元の文字列が空である場合は、入力を無効とし、ユーザーに再入力を要求するエラーメッセージを表示すること。

### 5. MVP設計提案

上記要件を満たすための、最初のシンプルな実装案です。

-   **ユーザー識別方法**:
    -   UIの上部に「ユーザーID」を入力するためのテキストボックス (`gr.Textbox`) を追加する。ユーザーはセッションの開始時に、自分のID（例: `test_user_01`）を入力する。このIDが、そのセッション中の操作の基点となる。

-   **データ保存フォーマット**:
    -   各会話履歴は、以下の構造を持つJSONファイルとして保存する。
        ```json
        {
          "system_prompt": "（ここにシステムプロンプトの文字列）",
          "turns": [
            {"role": "user", "content": "こんにちは"},
            {"role": "assistant", "content": "こんにちは、何かお手伝いできますか？"}
          ],
          "metadata": {
            "model": "（使用したモデル名）",
            "created_at": "（作成日時）"
          }
        }
        ```

-   **データ保存方法**:
    -   プロジェクトのルートに `chat_histories/` というディレクトリを作成する。
    -   その中に、ユーザーIDをBase64エンコードした名前のサブディレクトリを作成する。
    -   各会話履歴は、ユーザーが付けた保存名をBase64エンコードしたファイル名を持つJSONファイルとして、対応するユーザーのディレクトリ内に保存する。

-   **UIの変更点**:
    -   現在のチャットインターフェースに、**「履歴管理」**のための新しいUI領域を追加する。
    -   **「履歴管理」領域のコンポーネント**:
        -   `gr.Dropdown`: 保存済みの会話履歴の一覧を表示するドロップダウン。ユーザーIDの入力・変更時、および会話の保存・削除・新規作成が成功したタイミングで、対応するディレクトリをスキャンし、ドロップダウンの選択肢を更新する。
        -   `gr.Button`: 「選択した会話を読み込む」ボタン。
        -   `gr.Textbox`: 「新しい会話の保存名」を入力するテキストボックス。
        -   `gr.Button`: 「現在の会話を保存」ボタン。
        -   `gr.Button`: 「新しい会話を開始」ボタン。

### 6. エラーハンドリング
-   **ファイルI/Oエラー**: 履歴の読み書きに失敗した場合（例: ディスク容量不足、パーミッションエラー）、その旨をログに出力し、UI上でユーザーに「履歴の保存/読み込みに失敗しました」というエラーメッセージを表示する。

### 7. 将来の展望

-   **認証**: MVPの「ユーザーID」テキストボックスを、本格的なログインシステムに置き換える。
-   **データベース**: ファイルベースの保存から、SQLiteやより大規模なデータベースシステムへの移行を検討する。
