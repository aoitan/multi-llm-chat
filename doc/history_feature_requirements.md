# 新機能要件定義：会話履歴の保存・管理機能

### 1. 概要

現在のチャットアプリケーションに、会話履歴を永続化し、ユーザーごとに管理する機能を追加する。ユーザーは複数の会話履歴を保存し、後から呼び出すことができる。将来的な認証機能の導入を見据え、拡張性の高い設計とする。

### 2. 機能要件 (FR)

-   **FR-1: ユーザー識別**
    -   システムはユーザーを一意に識別できること。
    -   MVP（Minimum Viable Product）段階では、ユーザーが任意の「ユーザーID」を入力する方式とする。

-   **FR-2: 履歴の永続化**
    -   会話履歴は、アプリケーションを再起動しても失われないように永続化されること。
    -   MVP段階では、ローカルファイルシステムへの保存を想定する。

-   **FR-3: 複数履歴の管理**
    -   一人のユーザーは、複数の会話履歴をそれぞれ異なる名前で保存・管理できること。

-   **FR-4: 新規会話の開始**
    -   ユーザーはいつでも現在の会話をクリアし、新しい会話を開始できること。

-   **FR-5: 会話の保存**
    -   ユーザーは現在の会話履歴に名前を付けて保存できること。

-   **FR-6: 会話の読み込み**
    -   ユーザーは保存済みの会話履歴の一覧から一つを選択し、現在のチャットに読み込んで会話を再開できること。

### 3. 非機能要件 (NFR)

-   **NFR-1: プライバシー**
    -   あるユーザーの会話履歴は、他のユーザーからは閲覧・アクセスできないこと。データはユーザーIDによって明確に分離される必要がある。

-   **NFR-2: 拡張性**
    -   ユーザー識別メカニズムは、将来的にOAuthなどの本格的な認証システムに置き換え可能であるように設計すること。

### 4. MVP設計提案

上記要件を満たすための、最初のシンプルな実装案です。

-   **ユーザー識別方法**:
    -   UIの上部に「ユーザーID」を入力するためのテキストボックス (`gr.Textbox`) を追加する。ユーザーはセッションの開始時に、自分のID（例: `test_user_01`）を入力する。このIDが、そのセッション中の操作の基点となる。

-   **データ保存方法**:
    -   プロジェクトのルートに `chat_histories/` というディレクトリを作成する。
    -   その中に、ユーザーIDごとのサブディレクトリを作成する (例: `chat_histories/test_user_01/`)。
    -   各会話履歴は、ユーザーが付けた名前をファイル名にしたJSONファイルとして、対応するユーザーのディレクトリ内に保存する (例: `chat_histories/test_user_01/my_first_chat.json`)。

-   **UIの変更点**:
    -   現在のチャットインターフェースに、**「履歴管理」**のための新しいUI領域を追加する。
    -   **「履歴管理」領域のコンポーネント**:
        -   `gr.Dropdown`: 保存済みの会話履歴の一覧を表示するドロップダウン。
        -   `gr.Button`: 「選択した会話を読み込む」ボタン。
        -   `gr.Textbox`: 「新しい会話の保存名」を入力するテキストボックス。
        -   `gr.Button`: 「現在の会話を保存」ボタン。
        -   `gr.Button`: 「新しい会話を開始」ボタン。

### 5. 将来の展望

-   **認証**: MVPの「ユーザーID」テキストボックスを、本格的なログインシステムに置き換える。
-   **データベース**: ファイルベースの保存から、SQLiteやより大規模なデータベースシステムへの移行を検討する。
