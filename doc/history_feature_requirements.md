# 新機能要件定義：会話履歴の保存・管理機能

### 1. 概要

現在のチャットアプリケーションに、会話履歴を永続化し、ユーザーごとに管理する機能を追加する。ユーザーは複数の会話履歴を保存し、後から呼び出すことができる。将来的な認証機能の導入を見据え、拡張性の高い設計とする。

### 2. 機能要件 (FR)

-   **FR-1: ユーザー識別**
    -   システムはユーザーを一意に識別できること。
    -   MVP（Minimum Viable Product）段階では、ユーザーが任意の「ユーザーID」を入力する方式とする。**（※注意: SR-2で後述するなりすましリスクが存在する）**

-   **FR-2: 履歴の永続化**
    -   会話履歴は、アプリケーションを再起動しても失われないように永続化されること。
    -   MVP段階では、ローカルファイルシステムへの保存を想定する。

-   **FR-3: 複数履歴の管理**
    -   一人のユーザーは、複数の会話履歴をそれぞれ異なる名前で保存・管理できること。

-   **FR-4: 新規会話の開始**
    -   ユーザーはいつでも現在の会話をクリアし、新しい会話を開始できること。現在の会話が未保存の場合は、破棄される前に「現在の会話は保存されていません。破棄しますか？」といった確認メッセージをUI/CLI上に表示する。

-   **FR-5: 会話の保存**
    -   ユーザーは現在の会話履歴に名前を付けて保存できること。

-   **FR-6: 会話の読み込み**
    -   ユーザーは保存済みの会話履歴の一覧から一つを選択し、現在のチャットに読み込んで会話を再開できること。
    -   会話の読み込み時、現在の未保存の会話は破棄される。事前に「現在の会話は保存されていません。新しい履歴を読み込みますか？」といった確認メッセージをUI/CLI上に表示すること。
    -   読み込まれた履歴には、保存されていたシステムプロンプトも復元されること。（`system_prompt_feature_requirements.md` の実装に依存）

-   **FR-7: 上書き保存の制御**
    -   ユーザーが現在の会話を保存しようとする際、まず入力された「保存名」に対してSR-1のサニタイズ処理を行う。サニタイズ後の名前が空文字列になった場合はエラーとし、ユーザーに再入力を促す。
    -   サニタイズ後の名前が既存の保存名と重複する場合、「同じ名前の履歴が存在します。上書きしますか？」という確認をUI/CLI上で表示し、同意が得られた場合のみ上書き保存を実行する。

### 3. 非機能要件 (NFR)

-   **NFR-1: プライバシー**
    -   **設計目標**: あるユーザーの会話履歴は、他のユーザーからは閲覧・アクセスできないこと。データはユーザーIDによって明確に分離される必要がある。
    -   **MVPでの制約**: SR-2に記載の通り、MVP段階ではなりすましが可能であり、この要件は完全には満たされない。

-   **NFR-2: 拡張性**
    -   ユーザー識別メカニズムは、将来的にOAuthなどの本格的な認証システムに置き換え可能であるように設計すること。平文のユーザーIDから認証済みIDへのデータマイグレーションパスも将来的に考慮する必要がある。
    -   履歴保存フォーマットは、将来の拡張を考慮し、柔軟な構造とすること。

### 4. セキュリティ要件 (SR)

-   **SR-1: 不正なファイルパス対策**
    -   ユーザーが入力する「ユーザーID」および「会話の保存名」は、ファイルシステム上で安全な名前に変換（サニタイズ）すること。
    -   **サニタイズ方式**: PoC段階ではデバッグのしやすさを優先し、以下のルールを適用する。
        -   許可する文字: 半角英数字 (`a-zA-Z0-9`), アンダースコア (`_`), ハイフン (`-`)
        -   上記以外の文字は、すべてアンダースコア (`_`) に置換する。
        -   変換後の文字列が空、または `.` や `..` のみになる場合は、入力を無効とし、ユーザーに再入力を要求するエラーメッセージを表示すること。
    -   **注意**: このサニタイズ方式では、異なる入力（例: `history-1` と `history?1`）が同じ保存名（`history_1`）に変換される可能性がある。これはPoC段階での許容リスクとする。

-   **SR-2: なりすましリスクの許容と警告**
    -   MVPのユーザーID入力方式は、他人のユーザーIDを知っていれば誰でもその人の履歴にアクセスできる「なりすまし」のリスクを持つ。
    -   PoC段階ではこのリスクを許容するが、UI上でユーザーIDを入力する際に「これはユーザー認証ではありません。ローカルでのテスト目的です」といった警告メッセージを表示し、リスクをユーザーに通知すること。

-   **SR-3: 履歴ファイルの漏えい対策**
    -   会話履歴が保存される `chat_histories/` ディレクトリは、Gitの管理対象から除外すること。
    -   プロジェクトの `.gitignore` ファイルに `chat_histories/` を追加する。

### 5. MVP設計提案

上記要件を満たすための、最初のシンプルな実装案です。

-   **ユーザー識別方法**:
    -   **Web UI**: UIの上部に「ユーザーID」を入力するためのテキストボックス (`gr.Textbox`) と警告メッセージ (`gr.Markdown`) を追加する。ユーザーIDが入力されるまで、チャット入力や履歴管理UIは無効化（`interactive=False`）する。
    -   **CLI**: 起動時にユーザーIDの入力を要求する。入力されるまで対話を開始しない。

-   **データ保存フォーマット**:
    -   各会話履歴は、以下の構造を持つJSONファイルとして保存する。
        ```json
        {
          "display_name": "（サニタイズ前の元の保存名）",
          "system_prompt": "（ここにシステムプロンプトの文字列）",
          "turns": [
            {
              "role": "user",
              "content": "こんにちは"
            },
            {
              "role": "assistant",
              "content": "こんにちは、何かお手伝いできますか？",
              "model": "gemini-pro"
            }
          ],
          "metadata": {
            "schema_version": 1,
            "created_at": "（作成日時 ISO 8601形式）",
            "updated_at": "（最終更新日時 ISO 8601形式）"
          }
        }
        ```

-   **データ保存方法**:
    -   プロジェクトのルートに `chat_histories/` というディレクトリを作成する。
    -   その中に、SR-1に従ってサニタイズされたユーザーID名のサブディレクトリを作成する。
    -   各会話履歴は、SR-1に従ってサニタイズされた保存名をファイル名に持つJSONファイルとして、対応するユーザーのディレクトリ内に保存する。

-   **Web UIでの操作**:
    -   現在のチャットインターフェースに、**「履歴管理」**のための新しいUI領域を追加する。
    -   **「履歴管理」領域のコンポーネント**:
        -   `gr.Dropdown`: 保存済みの会話履歴の一覧を表示するドロップダウン。表示名はJSON内の`display_name`を使用する。ユーザーIDの入力・変更時、および会話の保存・削除・新規作成が成功したタイミングで、対応するディレクトリをスキャンし、ドロップダウンの選択肢を更新する。
        -   `gr.Button`: 「選択した会話を読み込む」ボタン。
        -   `gr.Textbox`: 「新しい会話の保存名」を入力するテキストボックス。空の場合は「現在の会話を保存」ボタンを無効化する。
        -   `gr.Button`: 「現在の会話を保存」ボタン。
        -   `gr.Button`: 「新しい会話を開始」ボタン。

-   **CLIでの操作**:
    -   履歴管理のために、以下のコマンド体系を導入する。コマンドの引数となる`<表示名>`は、JSONデータ内の`display_name`フィールドに対応する。
    -   **注意**: `<表示名>`にスペースが含まれる場合は、`"my first chat"` のようにダブルクォーテーションで囲む必要がある。
        -   `/history list`: 保存済みの会話履歴の一覧（`display_name`）を表示する。
        -   `/history save <表示名>`: 現在の会話を`<表示名>`で保存する。
        -   `/history load <表示名>`: `<表示名>`に一致する会話履歴を読み込む。
        -   `/history new`: 新しい会話を開始する。
    -   実装は、指定された`<表示名>`を元に対応するJSONファイルを検索し、処理を行う必要がある。

### 6. エラーハンドリング
-   **ファイルI/Oエラー**: 履歴の読み書きに失敗した場合（例: ディスク容量不足、パーミッションエラー）、その旨をログに出力し、UI/CLI上で「エラー: 履歴の保存/読み込みに失敗しました」という明確なエラーメッセージを表示する。
-   **不正な入力**: SR-1で定義された無効なユーザーIDや保存名が入力された場合、「エラー: 無効な名前です。許可される文字は英数字、ハイフン、アンダースコアのみです」といったメッセージを表示する。

### 7. 将来の展望

-   **認証**: MVPの「ユーザーID」テキストボックスを、本格的なログインシステム（例: OAuth）に置き換える。ユーザーディレクトリ名は、平文のIDではなく、ハッシュ化したIDやUUIDを使用することでプライバシーを強化する。
-   **データベース**: ファイルベースの保存から、SQLiteやより大規模なデータベースシステムへの移行を検討する。
