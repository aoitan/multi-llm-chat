# Issue #103 ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°çµæœãƒ¡ãƒˆãƒªã‚¯ã‚¹

## å®Ÿæ–½æ¦‚è¦

Issue #103 ã®ç›®æ¨™ã§ã‚ã‚‹ã€Œcore.py ã®å±¥æ­´ç®¡ç†ãƒ»æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢ã€ã‚’ã€
æ®µéšçš„ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«ã‚ˆã‚Šå®Ÿæ–½ã—ã¾ã—ãŸã€‚

## å®Ÿæ–½æœŸé–“

- é–‹å§‹: 2026-01-31
- å®Œäº†: 2026-01-31
- ã‚³ãƒŸãƒƒãƒˆæ•°: 5ã‚³ãƒŸãƒƒãƒˆ

## ã‚³ãƒ¼ãƒ‰è¡Œæ•°ã®å¤‰åŒ–

### core.py

| é …ç›® | Before | After | å¤‰åŒ– |
|------|--------|-------|------|
| ç·è¡Œæ•° | 735è¡Œ | 740è¡Œ | +5è¡Œ |
| é–¢æ•°ãƒ»ã‚¯ãƒ©ã‚¹æ•° | 19å€‹ | 19å€‹ | å¤‰åŒ–ãªã— |

**æ³¨**: è¡Œæ•°å¢—åŠ ã¯ wrapper åŒ–ã«ã‚ˆã‚‹ä¸€æ™‚çš„ãªã‚‚ã®

### å®Ÿè³ªçš„ãªè²¬å‹™ç§»å‹•

ä»¥ä¸‹ã®é–¢æ•°ã‚’å°‚ç”¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸ç§»å‹•ã—ã¾ã—ãŸï¼š

1. **`load_api_key()` â†’ llm_provider.py**
   - ç§»å‹•å‰: core.py ã« 3è¡Œã®å®Ÿè£…
   - ç§»å‹•å¾Œ: llm_provider.py ã«æœ¬ä½“ã€core.py ã«ã¯ wrapperï¼ˆ9è¡Œï¼‰
   - ãƒ†ã‚¹ãƒˆ: test_llm_provider.py ã«è¿½åŠ 

### æ—¢å­˜ã®å§”è­²çŠ¶æ³

ä»¥ä¸‹ã®é–¢æ•°ã¯**Issue #103 ä»¥å‰ã«æ—¢ã«å§”è­²æ¸ˆã¿**ã§ã‚ã‚Šã€core.py ã«ã¯è–„ã„ wrapper ã®ã¿æ®‹ã£ã¦ã„ã¾ã™ï¼š

| é–¢æ•°å | å§”è­²å…ˆ | Wrapperè¡Œæ•° |
|--------|--------|-------------|
| `format_history_for_gemini()` | `GeminiProvider.format_history()` | 7è¡Œ |
| `format_history_for_chatgpt()` | `ChatGPTProvider.format_history()` | 7è¡Œ |
| `extract_text_from_chunk()` | `provider.extract_text_from_chunk()` | 15è¡Œ |
| `prepare_request()` | `history_utils._prepare_request()` | 3è¡Œ |
| `_estimate_tokens()` | `token_utils._estimate_tokens_impl()` | 2è¡Œ |
| `get_max_context_length()` | `token_utils._get_max_context_length()` | 2è¡Œ |
| `prune_history_sliding_window()` | `compression._prune_history_sliding_window()` | 6è¡Œ |
| `get_pruning_info()` | `compression._get_pruning_info()` | 6è¡Œ |
| `validate_system_prompt_length()` | `validation._validate_system_prompt_length()` | 6è¡Œ |
| `validate_context_length()` | `validation._validate_context_length()` | 6è¡Œ |

**åˆè¨ˆ wrapper è¡Œæ•°**: 60è¡Œ

ã“ã‚Œã‚‰ã¯å…¬é–‹ API ã¨ã—ã¦äº’æ›æ€§ã‚’ä¿ã¤ãŸã‚ã€core.py ã«æ®‹ã—ã¦ã„ã¾ã™ã€‚

## core.py ã®ç¾åœ¨ã®æ§‹æˆ

### ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆæ®‹ã™ã¹ãæ©Ÿèƒ½ï¼‰

| é–¢æ•°å | è¡Œæ•° | å½¹å‰² |
|--------|------|------|
| `AgenticLoopResult` | 21è¡Œ | ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ |
| `call_gemini_api()` | 43è¡Œ | Gemini APIå‘¼ã³å‡ºã— |
| `call_chatgpt_api()` | 32è¡Œ | ChatGPT APIå‘¼ã³å‡ºã— |
| `stream_text_events()` | 17è¡Œ | ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°åˆ¶å¾¡ |
| `execute_with_tools_stream()` | 169è¡Œ | Agentic Loopï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç‰ˆï¼‰ |
| `execute_with_tools()` | 144è¡Œ | Agentic Loopï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ |
| `execute_with_tools_sync()` | 53è¡Œ | Agentic Loopï¼ˆåŒæœŸç‰ˆï¼‰ |
| **å°è¨ˆ** | **479è¡Œ** | |

### ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»Wrapperå±¤

| é–¢æ•°å | è¡Œæ•° | å½¹å‰² |
|--------|------|------|
| `list_gemini_models()` | 27è¡Œ | ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆcoreå†…ã§ä½¿ç”¨ï¼‰ |
| `calculate_tokens()` | 8è¡Œ | ãƒˆãƒ¼ã‚¯ãƒ³è¨ˆç®—ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ |
| `get_token_info()` | 26è¡Œ | DEPRECATED wrapper |
| å„ç¨® wrapper | 60è¡Œ | ä¸Šè¨˜ã®å§”è­²æ¸ˆã¿é–¢æ•°ç¾¤ |
| **å°è¨ˆ** | **121è¡Œ** | |

### ãã®ä»–ï¼ˆimport, constantsç­‰ï¼‰

- **ç´„140è¡Œ**ï¼ˆimportæ–‡ã€å®šæ•°å®šç¾©ã€ç©ºè¡Œã€ã‚³ãƒ¡ãƒ³ãƒˆç­‰ï¼‰

**åˆè¨ˆ**: 479 + 121 + 140 = **740è¡Œ**

## ãƒ†ã‚¹ãƒˆã®çŠ¶æ³

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œæ•° | ãƒ†ã‚¹ãƒˆæ•° | å‚™è€ƒ |
|----------|------|----------|------|
| test_core.py | 421è¡Œ | 28ä»¶ | LLMå‘¼ã³å‡ºã—ã€wrapperæ¤œè¨¼ |
| test_llm_provider.py | 173è¡Œ | 18ä»¶ | load_api_keyè¿½åŠ  |
| test_history_utils.py | æ—¢å­˜ | æ—¢å­˜ | å±¥æ­´æ•´å½¢ |
| test_validation.py | æ—¢å­˜ | æ—¢å­˜ | æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ |
| test_token_utils.py | æ—¢å­˜ | æ—¢å­˜ | ãƒˆãƒ¼ã‚¯ãƒ³è¨ˆç®— |
| test_compression.py | æ—¢å­˜ | æ—¢å­˜ | å±¥æ­´åœ§ç¸® |

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ

```
âœ… 283 passed, 2 skipped, 50 warnings in 3.55s
```

å…¨ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã—ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ã¯ç¶­æŒã•ã‚Œã¦ã„ã¾ã™ã€‚

## ä»Šå›ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã®æˆæœ

### âœ… é”æˆã§ããŸã“ã¨

1. **è²¬å‹™ã®æ˜ç¢ºåŒ–**
   - `load_api_key()` ã‚’ llm_provider.py ã¸ç§»å‹•
   - æ—¢å­˜ã®å§”è­²æ¸ˆã¿é–¢æ•°ã‚’æ–‡æ›¸åŒ–

2. **ãƒ†ã‚¹ãƒˆã®æ•´å‚™**
   - å…±é€šãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ `conftest.py` ã«æŠ½å‡º
   - `test_llm_provider.py` ã«ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆè¿½åŠ 

3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™**
   - `doc/refactoring_dependencies.md` ä½œæˆï¼ˆä¾å­˜é–¢ä¿‚åˆ†æï¼‰
   - `doc/refactoring_metrics.md` ä½œæˆï¼ˆæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

4. **æ®µéšçš„ãªå®Ÿè£…**
   - 5ã‚³ãƒŸãƒƒãƒˆã«åˆ†å‰²ï¼ˆå„ < 100è¡Œï¼‰
   - å„ã‚³ãƒŸãƒƒãƒˆå¾Œã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå…¨ãƒ‘ã‚¹ï¼‰

### ğŸ” åˆ¤æ˜ã—ãŸã“ã¨

1. **æ—¢ã«å¤§éƒ¨åˆ†ãŒå§”è­²æ¸ˆã¿**
   - å±¥æ­´ç®¡ç† â†’ `history_utils.py`, `history.py`
   - æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ â†’ `validation.py`
   - ãƒˆãƒ¼ã‚¯ãƒ³è¨ˆç®— â†’ `token_utils.py`
   - åœ§ç¸®å‡¦ç† â†’ `compression.py`
   - ProvideræŠ½è±¡åŒ– â†’ `llm_provider.py`, `providers/`

2. **core.py ã®å®Ÿè³ªçš„ãªå½¹å‰²**
   - ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆLLMå‘¼ã³å‡ºã—ã€Agentic Loopï¼‰
   - å…¬é–‹ API ã®äº’æ›æ€§ç¶­æŒï¼ˆwrapperå±¤ï¼‰

3. **ç§»å‹•ãŒä¸é©åˆ‡ãªé–¢æ•°**
   - `list_gemini_models()`: core.py å†…éƒ¨ã§ä½¿ç”¨ã€CLIå±¤ã¸ã®ç§»å‹•ã¯å½±éŸ¿å¤§

## ä»Šå¾Œã®æ”¹å–„ææ¡ˆ

### çŸ­æœŸï¼ˆæ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ï¼‰

1. **DEPRECATED wrapperã®æ®µéšçš„å»ƒæ­¢**
   - `format_history_for_gemini/chatgpt()` ã‚’ Providerå±¤ã¸å®Œå…¨ç§»è¡Œ
   - `get_token_info()` ã®å‘¼ã³å‡ºã—å…ƒã‚’ `provider.get_token_info()` ã«å¤‰æ›´

2. **list_gemini_models() ã®æ‰±ã„**
   - CLIå°‚ç”¨ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦ `cli.py` ã¸ç§»å‹•
   - core.py ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‹ã‚‰å‰Šé™¤

### é•·æœŸï¼ˆå°†æ¥çš„ãªæ¤œè¨ï¼‰

1. **Agentic Loop ã®ç‹¬ç«‹**
   - `execute_with_tools_*()` ã‚’ `agentic_loop.py` ã¸åˆ†é›¢
   - core.py ã¯ç´”ç²‹ãª "APIå‘¼ã³å‡ºã—ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼" ã«

2. **Backward Compatibilityå±¤ã®åˆ†é›¢**
   - `core_compat.py` ã‚’ä½œæˆã—ã€DEPRECATED wrapper ã‚’é›†ç´„
   - æ–°è¦ã‚³ãƒ¼ãƒ‰ã¯ç›´æ¥ Providerå±¤ã‚„ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å±¤ã‚’åˆ©ç”¨

## ã¾ã¨ã‚

Issue #103 ã®ç›®æ¨™ã€Œå±¥æ­´ç®¡ç†ãƒ»æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢ã€ã¯ã€**æ—¢ã«å¤§éƒ¨åˆ†ãŒé”æˆæ¸ˆã¿**ã§ã—ãŸã€‚
ä»Šå›ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã§ã¯ã€æ®‹å­˜ã—ã¦ã„ãŸ `load_api_key()` ã‚’ç§»å‹•ã—ã€
æ—¢å­˜ã®å§”è­²çŠ¶æ³ã‚’æ–‡æ›¸åŒ–ã™ã‚‹ã“ã¨ã§ã€ä¿å®ˆæ€§ã‚’å‘ä¸Šã•ã›ã¾ã—ãŸã€‚

core.py ã¯ç¾åœ¨ã€ä»¥ä¸‹ã®æ˜ç¢ºãªè²¬å‹™ã‚’æŒã£ã¦ã„ã¾ã™ï¼š

1. **ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: LLM APIå‘¼ã³å‡ºã—ã¨Agentic Loopã®åˆ¶å¾¡
2. **äº’æ›æ€§ç¶­æŒ**: å…¬é–‹APIã®wrapperå±¤ã¨ã—ã¦å¾Œæ–¹äº’æ›æ€§ã‚’ä¿è¨¼

ä»Šå¾Œã¯ã€DEPRECATED wrapper ã®æ®µéšçš„å»ƒæ­¢ã¨ã€
Agentic Loop ã®ç‹¬ç«‹ã«ã‚ˆã‚Šã€ã•ã‚‰ãªã‚‹è²¬å‹™ã®æ˜ç¢ºåŒ–ãŒå¯èƒ½ã§ã™ã€‚
