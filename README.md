# Multi-LLM Chat

## 概要
このツールは、GeminiとChatGPTの2つの大規模言語モデル（LLM）に対し、単一のインターフェースから指示を出し、会話文脈を共有しながら対話を行うためのものです。ユーザーは「司会者」として、メンション機能を用いて応答するAIを指定できます。

Web UI版とCLI版の2つのインターフェースを提供します。

## 機能
- **Web UI**: Gradioによる、チャット形式の使いやすいグラフィカルインターフェース。
- **CLI (REPL)**: 従来のコマンドラインによる対話型インターフェース。
- **統一会話履歴管理**: セッション中の全てのやり取りを時系列で保持します。
- **メンション機能**: `@gemini`, `@chatgpt`, `@all` のメンションにより、特定のLLMまたは両方のLLMに応答をルーティングします。メンションなしの入力は思考メモとして履歴にのみ追加されます。
- **API連携**: Google Gemini APIおよびOpenAI ChatGPT APIとの連携をサポートします。
- **環境変数からのAPIキー読み込み**: APIキーは環境変数または`.env`ファイルから安全に読み込まれます。

## インストール

1. **リポジトリのクローン**:
   ```bash
   git clone <リポジトリのURL>
   cd multi-llm-chat/repo
   ```

2. **`uv`のインストール**:
   Pythonのパッケージ管理ツール`uv`をインストールします。詳細な手順は[uvの公式ドキュメント](https://docs.astral.sh/uv/installation/)を参照してください。
   例 (macOS/Linux):
   ```bash
   curl -LsSf https://astral.sh/uv/install.sh | sh
   ```

3. **仮想環境の作成とアクティベート**:
   ```bash
   uv venv .venv
   source .venv/bin/activate
   ```

4. **依存関係のインストール**:
   ```bash
   uv pip install google-generativeai openai python-dotenv gradio
   ```

## 使い方

**注意: 現在、全体リファクタリングが計画されています。以下の手順はリファクタリング完了後のものです。現行バージョンでは、`webui.py`を`app.py`に、`cli.py`を`chat_logic.py`に読み替えて実行してください。**

### 1. APIキーの設定

プロジェクトのルートディレクトリに`.env`ファイルを作成し、以下の形式でAPIキーを設定します。
```
GOOGLE_API_KEY="YOUR_GEMINI_API_KEY"
OPENAI_API_KEY="YOUR_OPENAI_API_KEY"
```
`GOOGLE_API_KEY`は必須です。`OPENAI_API_KEY`はChatGPTを使用する場合に設定してください。

### 2. Web UI版の実行 (推奨)

仮想環境がアクティベートされていることを確認し、`webui.py`（現行: `app.py`）を実行します。
```bash
python webui.py
```
ブラウザで `http://127.0.0.1:7860` を開いてください。

#### ローカルネットワークでの共有

同じネットワーク上のスマートフォンなど、他のデバイスからアクセスしたい場合は、以下のコマンドでアプリケーションを起動します。

```bash
MLC_SERVER_NAME=0.0.0.0 python webui.py
```

### 3. CLI版の実行

コマンドラインで対話を行いたい場合は、`cli.py`（現行: `chat_logic.py`）を実行します。
```bash
python cli.py
```
プロンプト(`> `)が表示されたら、以下の形式で入力します。
- **Geminiに話しかける**: `@gemini こんにちは`
- **ChatGPTに話しかける**: `@chatgpt 自己紹介して`
- **両方に話しかける**: `@all 今日の天気は？`
- **思考メモ（API呼び出しなし）**: `これはメモです`
- **終了**: `exit` または `quit`

## 実装の優先順位と依存関係

機能開発は、以下の順序で進めることを推奨します。これは各仕様書間の依存関係を考慮したものです。

1.  **全体リファクタリング (`system_prompt_feature_requirements.md`)**
    -   まず`core.py`, `webui.py`, `cli.py`へのファイル分割リファクタリングを行います。
    -   この段階の`core.py`は、既存機能のロジックを移行させるとともに、今後実装する新機能（システムプロンプト、コンテキスト圧縮等）のためのインターフェース（空の関数やクラス）を定義します。

2.  **システムプロンプト機能 (`system_prompt_feature_requirements.md`)**
    -   リファクタリングで定義されたインターフェースに基づき、システムプロンプト機能のコアロジックとUIを実装します。
    -   **依存**: 全体リファクタリング

3.  **コンテキスト圧縮機能 と 会話履歴機能**
    -   以下の2つの機能は、システムプロンプト機能の実装後に並行して開発可能です。
    -   **コンテキスト圧縮機能 (`context_compression_requirements.md`)**
        -   `core.py`のコンテキスト圧縮インターフェースを実装します。システムプロンプトを圧縮対象から除外するロジックを含むため、システムプロンプト機能に依存します。
    -   **会話履歴の保存・管理機能 (`history_feature_requirements.md`)**
        -   `core.py`に履歴管理ロジックを実装します。システムプロンプトを履歴の一部として保存・復元するため、システムプロンプト機能に依存します。
    -   **統合テスト**: 3つの新機能は相互に影響するため、各機能の実装完了後、結合して動作を確認する統合テストを実施することが重要です。

## 開発ロードマップ
- [x] 実際のAPI呼び出しの実装
- [x] エラーハンドリングの強化
- [x] ストリーミング応答のサポート
- [x] GradioによるWeb UIの実装
- [ ] 設定ファイルの外部化
- [x] テストの追加

## ライセンス
[LICENSE](LICENSE) (TBD)